<!DOCTYPE html>
<html>
<head>
    <META HTTP-EQUIV="Access-Control-Allow-Origin" CONTENT="*">
    <META HTTP-EQUIV="X-Frame-Options" CONTENT="ALLOW-FROM *">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="config.js"></script>
    <script crossorigin="anonymous" language="JavaScript">
        const SCOPE = 'user:read';
        const TYPE = 'token';
        const _url = CONFIG.get('OAUTH_URL') + '?scope=' + SCOPE + '&client_id=' + CONFIG.get('CLIENT_ID')
            + '&redirect_uri=' + CONFIG.get('AUTH_REDIRECT') + '&response_type=' + TYPE;
        let loginWindow;
        window.jwt = '';
        window.authSuccess = false;

        $(function () {
            $("#tools").tabs();
            $("#ping_cmd").click(function (event) {
                event.preventDefault();
                const ping_url = CONFIG.get('BASE_URL') + "/api/v1/ping?ip=" + $('#ping_ip').val();
                getAndShowResults(ping_url, '#ping_results');
            });
            $("#traceroute_cmd").click(function (event) {
                event.preventDefault();
                const ping_url = CONFIG.get('BASE_URL') + "/api/v1/traceroute?ip=" + $('#traceroute_ip').val();
                getAndShowResults(ping_url, '#traceroute_results');
            });
            $("#mtr_cmd").click(function (event) {
                event.preventDefault();
                const ping_url = CONFIG.get('BASE_URL') + "/api/v1/mtr?ip=" + $('#mtr_ip').val();
                getAndShowResults(ping_url, '#mtr_results');
            });
        });

        function getAndShowResults(ping_url, result) {
            $(result).html("<pre>pending</pre>");
            $.ajax({
                url: ping_url,
                headers: {"Authorization": "Bearer " + window.jwt}
            }).done(function (data) {
                $(result).html("<pre>" + data + "</pre>");
            }).fail(function (data) {
                alert("error: " + data);
            });
        }

        function login() {
            window.authSuccess = false;
            loginWindow = window.open(_url, "login", 'width=800, height=600');

            const pollTimer = window.setInterval(function () {
                try {
                    if (window.authSuccess) {
                        window.clearInterval(pollTimer);
                        loginWindow.close();
                        $(".unauthenticated").hide()
                        $(".authenticated").show()
                        $("#user").html(parseJwt(window.jwt)['name']);
                    }
                } catch (e) {
                    console.log("error ", e);
                }
            }, 500);
        }

        function logout() {
            window.authSuccess = false;
            window.jwt = '';
            $(".authenticated").hide();
            $(".unauthenticated").show();
        }

        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }

    </script>
</head>

<body>
<div class="container unauthenticated">
    <a href='#' onClick='login();' id='loginText'> Click here to login with Github</a>
</div>
<div class="container authenticated" style="display: none">
    Logged in as: <span id="user"></span> <a href='#' onClick='logout();' id='logoutText'>logout</a>
    <div id="tools">
        <ul>
            <li><a href="#ping">Ping</a></li>
            <li><a href="#traceroute">Traceroute</a></li>
            <li><a href="#mtr">My Traceroute</a></li>
        </ul>
        <div id="ping">
            <p>Shows how long it takes for packets to reach host</p>
            <p>IP : <input type="textbox" value="" id="ping_ip"></p>
            <button class="ui-button ui-widget ui-corner-all" id="ping_cmd">Go</button>
            <p>
                <span>Results</span>
            <div id="ping_results">
            </div>
            </p>
        </div>
        <div id="traceroute">
            <p>Traces the route of packets to destination host from our server</p>
            <p>IP : <input type="textbox" value="" id="traceroute_ip"></p>
            <button class="ui-button ui-widget ui-corner-all" id="traceroute_cmd">Go</button>
            <p>
                <span>Results</span>
            <div id="traceroute_results">
            </div>
            </p>
        </div>
        <div id="mtr">
            <p>Mtr is a network diagnostic tool that combines ping and traceroute into one program</p>
            <p>IP : <input type="textbox" value="" id="mtr_ip"></p>
            <button class="ui-button ui-widget ui-corner-all" id="mtr_cmd">Go</button>
            <p>
                <span>Results</span>
            <div id="mtr_results">
            </div>
            </p>
        </div>
    </div>
</div>
</body>
</html>
